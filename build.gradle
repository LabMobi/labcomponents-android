// Top-level build file where you can add configuration options common to all sub-projects/modules.
buildscript {
    // To fetch deps from mobi's nexus or publish to nexus
    ext {
        def console = System.console()
        if (!project.hasProperty("nexusUser") && console) {
            ext.nexusUser = console.readLine("\n\n> Mobi Nexus Username: ").toString().trim()
        }
        if (!project.hasProperty("nexusPass") && console) {
            ext.nexusPass = console.readPassword("\n\n> Mobi Nexus Password: ").toString().trim()
        }
    }

    repositories {
        jcenter()
    }
    dependencies {
        classpath 'com.android.tools.build:gradle:2.3.0'
    }
}

ext {
    versionName = "0.0.1"
    versionCode = 1
    isRelease = false
}

static def getDate() {
    def date = new Date()
    def formattedDate = date.format('yyyy.MM.dd')
    return formattedDate
}


allprojects {
    buildscript {
        project.group = "mobi"
        // Yes yes, I am cheating here.
        project.ext.isRelease = project.gradle.startParameter.taskNames.contains("buildGreenhouseRelease")

        String suppliedBuildNumber = "$System.env.BUILD_NUMBER"
        // VersionName
        if (suppliedBuildNumber == null || suppliedBuildNumber.equals("") || suppliedBuildNumber.equals("null")) {
            project.ext.versionName = getDate() + (isRelease ? ".r" : ".d") + "1"
        } else {
            project.ext.versionName = getDate() + (isRelease ? ".r" : ".d") + suppliedBuildNumber
        }
        // This is the synonym
        project.version = project.ext.versionName

        // VersionCode
        if (suppliedBuildNumber == null || suppliedBuildNumber.equals("") || suppliedBuildNumber.equals("null")) {
            project.ext.versionCode = 1
        } else {
            project.ext.versionCode = Integer.valueOf(suppliedBuildNumber)
        }
    }
    repositories {
        jcenter()
        ivy {
            credentials {
                username project.nexusUser
                password project.nexusPass
            }
            url "https://nexus.lab.mobi/content/repositories/mobi-libs/"
            ivyPattern "https://nexus.lab.mobi/content/repositories/mobi-libs/[organisation]/[module](/[branch])/[revision]/ivy.xml"
            artifactPattern "https://nexus.lab.mobi/content/repositories/mobi-libs/[organisation]/[module](/[branch])/[revision]/[artifact].[ext]"
        }
    }
}

task clean(type: Delete) {
    delete rootProject.buildDir
}
